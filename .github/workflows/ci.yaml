---
name: ci

on:
  pull_request:
  push:
    branches:
      - main
      - release/**

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.26'

jobs:
  yamllint:
    name: yamllint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - name: Install yamllint
        run: python -m pip install --upgrade --user yamllint
      - name: Run yamllint
        run: ~/.local/bin/yamllint -c .yamllint.yml --strict .

  shellcheck:
    name: shellcheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: shellcheck
        uses: ludeeus/action-shellcheck@2.0.0

  build:
    name: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - run: go build -race ./...

  test:
    name: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Run tests
        run: go test -race -short ./...

  golangci-lint:
    name: golangci-lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - uses: golangci/golangci-lint-action@v9
        with:
          version: latest
          install-mode: goinstall

  buildDockerImage:
    name: build docker image
    runs-on: ubuntu-latest
    env:
      TAG: test
      ORG: networkservicemesh
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: build coredns binary
        working-directory: coredns
        run: go build -o coredns ./main.go
      - uses: docker/setup-buildx-action@v3
      - name: build docker image
        uses: docker/build-push-action@v6
        with:
          context: coredns
          push: false
          load: true
          tags: ${{ env.ORG }}/coredns:${{ env.TAG }}

  compliance:
    name: compliance checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Exclude fmt.Errorf
        run: |
          if grep -r --include='*.go' 'fmt.Errorf' . ; then
            echo "Please use errors.Errorf (or errors.New or errors.Wrap or errors.Wrapf) as appropriate rather than fmt.Errorf"
            exit 1
          fi
      - name: Restrict dependencies on github.com/networkservicemesh/*
        run: >
          disallowed="$(grep 'github.com/networkservicemesh/' go.mod
          | grep -v '^module'
          | sed 's;.*\(github.com/networkservicemesh/[A-Za-z/]\+\).*;\1;g'
          | sort -u
          | grep -v '^github.com/networkservicemesh/api$' || true)";
          test -z "$disallowed" || { echo "Forbidden dependencies found:"; echo "$disallowed"; exit 1; }
      - name: Exclude replace in go.mod
        run: |
          grep '^replace' go.mod || exit 0
          exit 1

  checkgomod:
    name: check go.mod and go.sum
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - run: go mod tidy
      - name: Check for changes in go.mod or go.sum
        run: git diff --exit-code -- go.mod go.sum

  license:
    name: license header check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Install go-header
        run: go install github.com/denis-tingajkin/go-header@v0.2.2
      - name: Run go-header
        run: $(go env GOPATH)/bin/go-header
